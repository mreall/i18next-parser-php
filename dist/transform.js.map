{"version":3,"file":"transform.js","names":["Transform","eol","fs","path","VirtualFile","yaml","i18next","sortKeys","dotPathToHash","mergeHashes","transferValues","makeDefaultSort","Parser","i18nTransform","_Transform","_inherits","_super","_createSuper","_this","options","arguments","length","undefined","_classCallCheck","objectMode","call","defaults","contextSeparator","createOldCatalogs","defaultNamespace","defaultValue","indentation","keepRemoved","keySeparator","lexers","lineEnding","locales","namespaceSeparator","pluralSeparator","output","resetDefaultValueLocale","sort","verbose","customValueTemplate","failOnWarnings","yamlOptions","_objectSpread","i18nextOptions","nsSeparator","entries","parserHadWarnings","parserHadUpdate","parser","on","error","warning","warn","localeRegex","namespaceRegex","createInstance","init","_createClass","key","value","emit","console","_transform","file","encoding","done","content","isBuffer","contents","toString","lstatSync","isDirectory","concat","readFileSync","log","filename","basename","parse","_iterator","_createForOfIteratorHelper","_step","s","n","entry","keyPrefix","parts","split","namespace","shift","join","replace","keyWithNamespace","addEntry","err","e","f","_flush","_this2","maybeSortedLocales","a","resetValues","_iterator2","_step2","_loop","locale","catalog","resetAndFlag","uniqueCount","uniquePluralsCount","transformEntry","suffix","_dotPathToHash","separator","duplicate","conflict","_iterator3","_step3","_loop2","count","services","pluralResolver","getSuffixes","ordinal","forEach","outputPath","resolve","namespacePath","parsedNamespacePath","namespaceOldPath","dir","name","ext","existingCatalog","getCatalog","existingOldCatalog","_mergeHashes","newCatalog","oldKeys","old","mergeCount","oldCount","resetFlags","reset","resetCount","_mergeHashes2","oldCatalog","restoreCount","addCount","failOnUpdate","maybeSortedNewCatalog","maybeSortedOldCatalog","compare","deep","pushFile","Object","keys","process","exit","context","contextEntry","assign","push","endsWith","load","JSON","code","text","dump","indent","stringify","chr","charCodeAt","substr","auto","crlf","cr","lf","Buffer","from","default"],"sources":["../src/transform.js"],"sourcesContent":["import { Transform } from 'stream'\r\nimport eol from 'eol'\r\nimport fs from 'fs'\r\nimport path from 'path'\r\nimport VirtualFile from 'vinyl'\r\nimport yaml from 'js-yaml'\r\nimport i18next from 'i18next'\r\nimport sortKeys from 'sort-keys'\r\n\r\nimport {\r\n  dotPathToHash,\r\n  mergeHashes,\r\n  transferValues,\r\n  makeDefaultSort,\r\n} from './helpers.js'\r\nimport Parser from './parser.js'\r\n\r\nexport default class i18nTransform extends Transform {\r\n  constructor(options = {}) {\r\n    options.objectMode = true\r\n    super(options)\r\n\r\n    this.defaults = {\r\n      contextSeparator: '_',\r\n      createOldCatalogs: true,\r\n      defaultNamespace: 'translation',\r\n      defaultValue: '',\r\n      indentation: 2,\r\n      keepRemoved: false,\r\n      keySeparator: '.',\r\n      lexers: {},\r\n      lineEnding: 'auto',\r\n      locales: ['en', 'fr'],\r\n      namespaceSeparator: ':',\r\n      pluralSeparator: '_',\r\n      output: 'locales/$LOCALE/$NAMESPACE.json',\r\n      resetDefaultValueLocale: null,\r\n      sort: false,\r\n      verbose: false,\r\n      customValueTemplate: null,\r\n      failOnWarnings: false,\r\n      yamlOptions: null,\r\n    }\r\n\r\n    this.options = { ...this.defaults, ...options }\r\n    this.options.i18nextOptions = {\r\n      ...options.i18nextOptions,\r\n      pluralSeparator: this.options.pluralSeparator,\r\n      nsSeparator: this.options.namespaceSeparator,\r\n    }\r\n\r\n    if (this.options.keySeparator === false) {\r\n      this.options.keySeparator = '__!NO_KEY_SEPARATOR!__'\r\n    }\r\n    if (this.options.namespaceSeparator === false) {\r\n      this.options.namespaceSeparator = '__!NO_NAMESPACE_SEPARATOR!__'\r\n    }\r\n    this.entries = []\r\n\r\n    this.parserHadWarnings = false\r\n    this.parserHadUpdate = false\r\n    this.parser = new Parser(this.options)\r\n    this.parser.on('error', (error) => this.error(error))\r\n    this.parser.on('warning', (warning) => this.warn(warning))\r\n\r\n    this.localeRegex = /\\$LOCALE/g\r\n    this.namespaceRegex = /\\$NAMESPACE/g\r\n\r\n    this.i18next = i18next.createInstance()\r\n    this.i18next.init(this.options.i18nextOptions)\r\n  }\r\n\r\n  error(error) {\r\n    this.emit('error', error)\r\n    if (this.options.verbose) {\r\n      console.error('\\x1b[31m%s\\x1b[0m', error)\r\n    }\r\n  }\r\n\r\n  warn(warning) {\r\n    this.emit('warning', warning)\r\n    this.parserHadWarnings = true\r\n    if (this.options.verbose) {\r\n      console.warn('\\x1b[33m%s\\x1b[0m', warning)\r\n    }\r\n  }\r\n\r\n  _transform(file, encoding, done) {\r\n    let content\r\n    if (file.isBuffer()) {\r\n      content = file.contents.toString('utf8')\r\n    } else if (fs.lstatSync(file.path).isDirectory()) {\r\n      const warning = `${file.path} is a directory: skipping`\r\n      this.warn(warning)\r\n      done()\r\n      return\r\n    } else {\r\n      content = fs.readFileSync(file.path, encoding)\r\n    }\r\n\r\n    this.emit('reading', file)\r\n    if (this.options.verbose) {\r\n      console.log(`Parsing ${file.path}`)\r\n    }\r\n\r\n    const filename = path.basename(file.path)\r\n    const entries = this.parser.parse(content, filename)\r\n\r\n    for (const entry of entries) {\r\n      let key = entry.key\r\n\r\n      if (entry.keyPrefix) {\r\n        key = entry.keyPrefix + this.options.keySeparator + key\r\n      }\r\n\r\n      const parts = key.split(this.options.namespaceSeparator)\r\n\r\n      // make sure we're not pulling a 'namespace' out of a default value\r\n      if (parts.length > 1 && key !== entry.defaultValue) {\r\n        entry.namespace = parts.shift()\r\n      }\r\n      entry.namespace = entry.namespace || this.options.defaultNamespace\r\n\r\n      key = parts.join(this.options.namespaceSeparator)\r\n      key = key.replace(/\\\\('|\"|`)/g, '$1')\r\n      key = key.replace(/\\\\n/g, '\\n')\r\n      key = key.replace(/\\\\r/g, '\\r')\r\n      key = key.replace(/\\\\t/g, '\\t')\r\n      key = key.replace(/\\\\\\\\/g, '\\\\')\r\n      entry.key = key\r\n      entry.keyWithNamespace = entry.namespace + this.options.keySeparator + key\r\n\r\n      this.addEntry(entry)\r\n    }\r\n\r\n    done()\r\n  }\r\n\r\n  _flush(done) {\r\n    let maybeSortedLocales = this.options.locales\r\n    if (this.options.resetDefaultValueLocale) {\r\n      // ensure we process the reset locale first\r\n      maybeSortedLocales.sort((a) =>\r\n        a === this.options.resetDefaultValueLocale ? -1 : 1\r\n      )\r\n    }\r\n\r\n    // Tracks keys to reset by namespace\r\n    let resetValues = {}\r\n\r\n    for (const locale of maybeSortedLocales) {\r\n      const catalog = {}\r\n      const resetAndFlag = this.options.resetDefaultValueLocale === locale\r\n\r\n      let uniqueCount = {}\r\n      let uniquePluralsCount = {}\r\n\r\n      const transformEntry = (entry, suffix) => {\r\n        if (uniqueCount[entry.namespace] === undefined) {\r\n          uniqueCount[entry.namespace] = 0\r\n        }\r\n        if (uniquePluralsCount[entry.namespace] === undefined) {\r\n          uniquePluralsCount[entry.namespace] = 0\r\n        }\r\n\r\n        const { duplicate, conflict } = dotPathToHash(entry, catalog, {\r\n          suffix,\r\n          locale,\r\n          separator: this.options.keySeparator,\r\n          pluralSeparator: this.options.pluralSeparator,\r\n          value: this.options.defaultValue,\r\n          customValueTemplate: this.options.customValueTemplate,\r\n        })\r\n\r\n        if (duplicate) {\r\n          if (conflict === 'key') {\r\n            this.warn(\r\n              `Found translation key already mapped to a map or parent of ` +\r\n                `new key already mapped to a string: ${entry.key}`\r\n            )\r\n          } else if (conflict === 'value') {\r\n            this.warn(`Found same keys with different values: ${entry.key}`)\r\n          }\r\n        } else {\r\n          uniqueCount[entry.namespace] += 1\r\n          if (suffix) {\r\n            uniquePluralsCount[entry.namespace] += 1\r\n          }\r\n        }\r\n      }\r\n\r\n      // generates plurals according to i18next rules: key_zero, key_one, key_two, key_few, key_many and key_other\r\n      for (const entry of this.entries) {\r\n        if (\r\n          this.options.pluralSeparator !== false &&\r\n          entry.count !== undefined\r\n        ) {\r\n          this.i18next.services.pluralResolver\r\n            .getSuffixes(locale, { ordinal: entry.ordinal })\r\n            .forEach((suffix) => {\r\n              transformEntry(entry, suffix)\r\n            })\r\n        } else {\r\n          transformEntry(entry)\r\n        }\r\n      }\r\n\r\n      const outputPath = path.resolve(this.options.output)\r\n\r\n      for (const namespace in catalog) {\r\n        let namespacePath = outputPath\r\n        namespacePath = namespacePath.replace(this.localeRegex, locale)\r\n        namespacePath = namespacePath.replace(this.namespaceRegex, namespace)\r\n\r\n        let parsedNamespacePath = path.parse(namespacePath)\r\n\r\n        const namespaceOldPath = path.join(\r\n          parsedNamespacePath.dir,\r\n          `${parsedNamespacePath.name}_old${parsedNamespacePath.ext}`\r\n        )\r\n\r\n        let existingCatalog = this.getCatalog(namespacePath)\r\n        let existingOldCatalog = this.getCatalog(namespaceOldPath)\r\n\r\n        // merges existing translations with the new ones\r\n        const {\r\n          new: newCatalog,\r\n          old: oldKeys,\r\n          mergeCount,\r\n          oldCount,\r\n          reset: resetFlags,\r\n          resetCount,\r\n        } = mergeHashes(\r\n          existingCatalog,\r\n          catalog[namespace],\r\n          {\r\n            ...this.options,\r\n            resetAndFlag,\r\n          },\r\n          resetValues[namespace]\r\n        )\r\n\r\n        // record values to be reset\r\n        // assumes that the 'default' namespace is processed first\r\n        if (resetAndFlag && !resetValues[namespace]) {\r\n          resetValues[namespace] = resetFlags\r\n        }\r\n\r\n        // restore old translations\r\n        const { old: oldCatalog, mergeCount: restoreCount } = mergeHashes(\r\n          existingOldCatalog,\r\n          newCatalog,\r\n          { ...this.options, keepRemoved: false }\r\n        )\r\n\r\n        // backup unused translations\r\n        transferValues(oldKeys, oldCatalog)\r\n\r\n        if (this.options.verbose) {\r\n          console.log(`[${locale}] ${namespace}`)\r\n          console.log(\r\n            `Unique keys: ${uniqueCount[namespace]} (${uniquePluralsCount[namespace]} are plurals)`\r\n          )\r\n          const addCount = uniqueCount[namespace] - mergeCount\r\n          console.log(`Added keys: ${addCount}`)\r\n          console.log(`Restored keys: ${restoreCount}`)\r\n          if (this.options.keepRemoved) {\r\n            console.log(`Unreferenced keys: ${oldCount}`)\r\n          } else {\r\n            console.log(`Removed keys: ${oldCount}`)\r\n          }\r\n          if (this.options.resetDefaultValueLocale) {\r\n            console.log(`Reset keys: ${resetCount}`)\r\n          }\r\n          console.log('')\r\n        }\r\n\r\n        if (this.options.failOnUpdate) {\r\n          const addCount = uniqueCount[namespace] - mergeCount\r\n          if (addCount + restoreCount + oldCount !== 0) {\r\n            this.parserHadUpdate = true\r\n            continue\r\n          }\r\n        }\r\n\r\n        if (this.options.failOnWarnings && this.parserHadWarnings) {\r\n          continue\r\n        }\r\n\r\n        let maybeSortedNewCatalog = newCatalog\r\n        let maybeSortedOldCatalog = oldCatalog\r\n        const { sort } = this.options\r\n        if (sort) {\r\n          const compare =\r\n            typeof sort === 'function'\r\n              ? sort\r\n              : makeDefaultSort(this.options.pluralSeparator)\r\n          maybeSortedNewCatalog = sortKeys(newCatalog, { deep: true, compare })\r\n          maybeSortedOldCatalog = sortKeys(oldCatalog, { deep: true, compare })\r\n        }\r\n\r\n        // push files back to the stream\r\n        this.pushFile(namespacePath, maybeSortedNewCatalog)\r\n        if (\r\n          this.options.createOldCatalogs &&\r\n          (Object.keys(oldCatalog).length || existingOldCatalog)\r\n        ) {\r\n          this.pushFile(namespaceOldPath, maybeSortedOldCatalog)\r\n        }\r\n      }\r\n    }\r\n\r\n    if (this.options.failOnWarnings && this.parserHadWarnings) {\r\n      this.emit(\r\n        'error',\r\n        'Warnings were triggered and failOnWarnings option is enabled. Exiting...'\r\n      )\r\n      process.exit(1)\r\n    }\r\n\r\n    if (this.options.failOnUpdate && this.parserHadUpdate) {\r\n      this.emit(\r\n        'error',\r\n        'Some translations was updated and failOnUpdate option is enabled. Exiting...'\r\n      )\r\n      process.exit(1)\r\n    }\r\n\r\n    done()\r\n  }\r\n\r\n  addEntry(entry) {\r\n    if (entry.context) {\r\n      const contextEntry = Object.assign({}, entry)\r\n      delete contextEntry.context\r\n      contextEntry.key += this.options.contextSeparator + entry.context\r\n      contextEntry.keyWithNamespace +=\r\n        this.options.contextSeparator + entry.context\r\n      this.entries.push(contextEntry)\r\n    } else {\r\n      this.entries.push(entry)\r\n    }\r\n  }\r\n\r\n  getCatalog(path) {\r\n    try {\r\n      let content\r\n      if (path.endsWith('yml')) {\r\n        content = yaml.load(fs.readFileSync(path).toString())\r\n      } else {\r\n        content = JSON.parse(fs.readFileSync(path))\r\n      }\r\n      return content\r\n    } catch (error) {\r\n      if (error.code !== 'ENOENT') {\r\n        this.emit('error', error)\r\n      }\r\n    }\r\n\r\n    return null\r\n  }\r\n\r\n  pushFile(path, contents) {\r\n    let text\r\n    if (path.endsWith('yml')) {\r\n      text = yaml.dump(contents, {\r\n        indent: this.options.indentation,\r\n        ...this.options.yamlOptions,\r\n      })\r\n    } else {\r\n      text = JSON.stringify(contents, null, this.options.indentation) + '\\n'\r\n      // Convert non-printable Unicode characters to unicode escape sequence\r\n      // https://unicode.org/reports/tr18/#General_Category_Property\r\n      text = text.replace(/[\\p{Z}\\p{Cc}\\p{Cf}]/gu, (chr) => {\r\n        const n = chr.charCodeAt(0)\r\n        return n < 128 ? chr : `\\\\u${`0000${n.toString(16)}`.substr(-4)}`\r\n      })\r\n    }\r\n\r\n    if (this.options.lineEnding === 'auto') {\r\n      text = eol.auto(text)\r\n    } else if (\r\n      this.options.lineEnding === '\\r\\n' ||\r\n      this.options.lineEnding === 'crlf'\r\n    ) {\r\n      text = eol.crlf(text)\r\n    } else if (\r\n      this.options.lineEnding === '\\r' ||\r\n      this.options.lineEnding === 'cr'\r\n    ) {\r\n      text = eol.cr(text)\r\n    } else {\r\n      // Defaults to LF, aka \\n\r\n      text = eol.lf(text)\r\n    }\r\n\r\n    const file = new VirtualFile({\r\n      path,\r\n      contents: Buffer.from(text),\r\n    })\r\n    this.push(file)\r\n  }\r\n}\r\n"],"mappings":"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"}